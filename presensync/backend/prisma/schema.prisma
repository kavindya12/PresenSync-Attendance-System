// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  LECTURER
  ADMIN
  DEPT_HEAD
}

enum AttendanceMethod {
  QR
  NFC
  BEACON
  FACIAL
  MANUAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  CLASS_REMINDER
  ATTENDANCE_ALERT
  LEAVE_APPROVED
  LEAVE_REJECTED
  SYSTEM
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Nullable for OAuth users
  role          UserRole  @default(STUDENT)
  fullName      String    @map("full_name")
  studentId     String?   @unique @map("student_id") // Optional, for students
  department    String?
  avatarUrl     String?   @map("avatar_url")
  universityEmail String? @map("university_email")
  oauthProvider String?   @map("oauth_provider")
  oauthId       String?   @map("oauth_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  coursesTaught     Course[]           @relation("CourseLecturer")
  enrollments       CourseEnrollment[]
  attendanceRecords AttendanceRecord[]
  leaveRequests     LeaveRequest[]
  notifications     Notification[]
  streaks           AttendanceStreak[]
  achievements      Achievement[]
  approvedLeaves    LeaveRequest[]     @relation("ApprovedBy")

  @@map("profiles")
  @@index([email])
  @@index([role])
  @@index([studentId])
}

model Course {
  id          String   @id @default(uuid())
  code        String
  name        String
  semester    String?
  lecturerId  String   @map("lecturer_id")
  department  String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  lecturer     User              @relation("CourseLecturer", fields: [lecturerId], references: [id])
  enrollments  CourseEnrollment[]
  classes      Class[]
  streaks      AttendanceStreak[]

  @@map("courses")
  @@index([lecturerId])
  @@index([code])
}

model CourseEnrollment {
  id         String   @id @default(uuid())
  courseId   String   @map("course_id")
  studentId  String   @map("student_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at")

  // Relations
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
  @@map("course_enrollments")
  @@index([courseId])
  @@index([studentId])
}

model Class {
  id            String   @id @default(uuid())
  courseId      String   @map("course_id")
  title         String   // e.g., "Lecture 1", "Lab Session 2"
  room          String?
  startTime     DateTime @map("start_time")
  endTime       DateTime @map("end_time")
  qrCode        String?  @map("qr_code_content") // Adjusted to match SQL
  qrCodeExpiry  DateTime? @map("qr_code_expiry")
  nfcTagId      String?  @map("nfc_tag_id")
  beaconId      String?  @map("beacon_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  course            Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]
  leaveRequests     LeaveRequest[]
  beacon            Beacon?

  @@map("classes")
  @@index([courseId])
  @@index([startTime])
}

model AttendanceRecord {
  id        String           @id @default(uuid())
  classId   String           @map("class_id")
  studentId String           @map("student_id")
  method    AttendanceMethod? @default(QR) // Match check constraints if needed
  status    AttendanceStatus? @default(PRESENT)
  timestamp DateTime         @default(now()) @map("timestamp")
  latitude  Float?
  longitude Float?
  reason    String?          // For manual override
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("attendance_records")
  @@index([classId])
  @@index([studentId])
  @@index([timestamp])
}

model LeaveRequest {
  id         String      @id @default(uuid())
  studentId  String      @map("student_id")
  classId    String?     @map("class_id")
  reason     String
  startDate  DateTime    @map("start_date")
  endDate    DateTime    @map("end_date")
  status     LeaveStatus @default(PENDING)
  approvedBy String?     @map("approved_by")
  approvedAt DateTime?   @map("approved_at")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  // Relations
  student    User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class      Class? @relation(fields: [classId], references: [id], onDelete: SetNull)
  approver   User?  @relation("ApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)

  @@map("leaves")
  @@index([studentId])
  @@index([status])
}

model Notification {
  id        String          @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean         @default(false)
  createdAt DateTime        @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Beacon {
  id        String   @id @default(uuid())
  classId   String   @unique
  uuid      String   // Bluetooth beacon UUID
  major     Int
  minor     Int
  location  String?  // Room/location description
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([uuid, major, minor])
}

model AttendanceStreak {
  id               String   @id @default(uuid())
  studentId        String
  courseId         String
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastAttendanceDate DateTime?

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
}

enum BadgeType {
  PERFECT_WEEK
  PERFECT_MONTH
  STREAK_10
  STREAK_30
  EARLY_BIRD
  CONSISTENT
}

model Achievement {
  id        String    @id @default(uuid())
  studentId String
  badgeType BadgeType
  earnedAt  DateTime  @default(now())

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeType])
  @@index([studentId])
}

